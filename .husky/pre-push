#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push quality validation..."

# Get the branch being pushed
branch=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“ Pushing branch: $branch"

# Run comprehensive test suite with coverage
echo "ğŸ§ª Running test suite with coverage..."
if ! npm run test:coverage; then
  echo "âŒ Tests failed! Push aborted."
  exit 1
fi

# Run quality gates validation
echo "ğŸšª Running quality gates validation..."
if ! npm run validate:quality; then
  echo "âŒ Quality gates failed! Push aborted."
  echo "ğŸ’¡ Run 'npm run validate:quality:fix' to attempt automatic fixes"
  exit 1
fi

# Additional checks for main/master branch
if [ "$branch" = "main" ] || [ "$branch" = "master" ]; then
  echo "ğŸ·ï¸ Main branch detected, running additional checks..."
  
  # Run security audit
  echo "ğŸ”’ Running security audit..."
  if ! npm audit --audit-level=moderate; then
    echo "âš ï¸ Security vulnerabilities detected on main branch!"
    echo "Please run 'npm audit fix' to resolve issues"
    exit 1
  fi
  
  # Run performance tests
  echo "âš¡ Running performance tests..."
  if ! npm run test:performance; then
    echo "âŒ Performance tests failed on main branch!"
    exit 1
  fi
  
  # Run accessibility tests
  echo "â™¿ Running accessibility tests..."
  if ! npm run test:a11y; then
    echo "âŒ Accessibility tests failed on main branch!"
    exit 1
  fi
fi

echo "âœ… All pre-push checks passed! Proceeding with push..."
